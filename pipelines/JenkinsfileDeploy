pipeline {
    agent any

    tools {
        maven 'Maven-3.9.6'
    }

    environment {
        NEXUS_URL = '152.53.145.17:30082'
        IMAGE_NAME = 'simple-springboot-webapp'
        IMAGE_TAG = "${BUILD_NUMBER}"
        APP_REPO = 'https://github.com/AdnanAlagic/simple-springboot-webapp.git'
        BUILDAH_ISOLATION = 'chroot'
        STORAGE_DRIVER = 'vfs'
    }

    stages {
        stage('Checkout App Repo') {
            steps {
                dir('app') {
                    git branch: 'master', url: "${APP_REPO}"
                }
            }
        }

        stage('Build Application') {
            steps {
                dir('app') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Setup Buildah') {
            steps {
                sh '''
                    if ! command -v buildah &> /dev/null; then
                        echo "Installing buildah..."
                        apt-get update
                        apt-get install -y buildah fuse-overlayfs
                    else
                        echo "Buildah already installed"
                        buildah --version
                    fi

                    mkdir -p /var/lib/containers

                    mkdir -p ~/.config/containers
                    cat > ~/.config/containers/storage.conf << EOF
[storage]
driver = "vfs"
runroot = "/tmp/containers"
graphroot = "/var/lib/containers"
EOF
                '''
            }
        }

        stage('Build and Push Image') {
            steps {
                dir('app') {
                    sh '''
                        export BUILDAH_ISOLATION=chroot

                        echo "Building image with buildah..."
                        buildah bud --storage-driver=vfs -t ${IMAGE_NAME}:${IMAGE_TAG} .

                        echo "Tagging images for Nexus..."
                        buildah tag ${IMAGE_NAME}:${IMAGE_TAG} ${NEXUS_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                        buildah tag ${IMAGE_NAME}:${IMAGE_TAG} ${NEXUS_URL}/${IMAGE_NAME}:latest

                        echo "Listing built images..."
                        buildah images

                        echo "Pushing to Nexus..."
                        buildah push --storage-driver=vfs --tls-verify=false ${NEXUS_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                        buildah push --storage-driver=vfs --tls-verify=false ${NEXUS_URL}/${IMAGE_NAME}:latest

                        echo "Images pushed successfully!"
                    '''
                }
            }
        }

        stage('Cleanup Images') {
            steps {
                sh '''
                    buildah rmi ${IMAGE_NAME}:${IMAGE_TAG} || true
                    buildah rmi ${NEXUS_URL}/${IMAGE_NAME}:${IMAGE_TAG} || true
                    buildah rmi ${NEXUS_URL}/${IMAGE_NAME}:latest || true
                '''
            }
        }
    }

    post {
        always {
            deleteDir()
        }
        success {
            echo "Pipeline completed successfully!"
            echo "Image pushed to: ${NEXUS_URL}/${IMAGE_NAME}:${IMAGE_TAG}"
            echo "Image pushed to: ${NEXUS_URL}/${IMAGE_NAME}:latest"
        }
        failure {
            echo "Pipeline failed!"
            echo "Check the logs above for details."
        }
    }
}